#!/bin/bash

set -e
echo
echo "---> Build started at $(date)"
echo
START=$SECONDS

# Unconditionally print elapsed build time at exit
function finish {
  echo "===> Elapsed time: $(($SECONDS - $START)) seconds"
}
trap finish EXIT

# By default the s2i build places the application source in /tmp/src directory. 
# This directory is where the source and other assets will be placed for the build process. 
# You can modify this location by setting the io.openshift.s2i.destination label or passing --destination flag, 
# in which case the sources will be placed in the src subdirectory of the directory you specified. 
# The destination in the above command (./) is using WORKDIR (usually set in the FROM docker image), 
# which we specified in our Dockerfile, and which is set to be /opt/app-root/src.
echo "---> Preparing source..."
cp -Rf /tmp/src/. ./
cd ./

# TODO: add compiler flags and linker options for default case
echo "---> Compiling and installing application source..."
swiftc *.swift -v -o ../app

echo
echo "---> Build completed at $(date)"

# Fix source directory permissions
fix-permissions ./